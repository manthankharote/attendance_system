<%- include('partials/_header') %>
<%- include('partials/_nav', { user: user }) %>

<main class="container">
    <div class="card" style="text-align: center;">
        <h2>Scan this QR Code for Attendance</h2>
        <p><strong>Class:</strong> <%= selectedClass.name %> | <strong>Date:</strong> <%= new Date(date).toLocaleDateString() %></p>
        <p><strong>Subject:</strong> <%= subject %> | <strong>Session:</strong> <%= session %></p>

        <img src="<%= qrCodeUrl %>" alt="Session QR Code" style="max-width: 300px; margin: 2rem auto; display: block;">

        <h3 id="scan-count">Scanned: 0 Students</h3>
        <ul id="scanned-list" style="list-style: none; padding: 0; max-height: 200px; overflow-y: auto;">
            </ul>

        <form action="/teacher/attendance/submit-session" method="POST" style="margin-top: 2rem;">
            <input type="hidden" name="classId" value="<%= classId %>">
            <input type="hidden" name="date" value="<%= date %>">
            <input type="hidden" name="subject" value="<%= subject %>">
            <input type="hidden" name="session" value="<%= session %>">
            
            <div id="present-students-container"></div>
            
            <button type="submit" class="btn btn-danger">End Session & Submit Attendance</button>
        </form>
    </div>
</main>

<script src="/socket.io/socket.io.js"></script>
<script>document.addEventListener('DOMContentLoaded', () => {
        const socket = io();
        const scanCountElement = document.getElementById('scan-count');
        const scannedListElement = document.getElementById('scanned-list');
        const formContainer = document.getElementById('present-students-container');
        
        const scannedStudentIds = new Set();
        
        socket.on('newStudentScanned', (data) => {
            // data contains: sessionIdentifier, studentName, studentId, studentSchoolId

            if (!scannedStudentIds.has(data.studentId)) {
                scannedStudentIds.add(data.studentId);
                
                // 1. Update Count
                scanCountElement.textContent = `Scanned: ${scannedStudentIds.size} Students`;
                
                // 2. Create the new List Item
                const listItem = document.createElement('li');
                // Add a data attribute for sorting
                listItem.setAttribute('data-roll', data.studentSchoolId); 
                listItem.textContent = `${data.studentName} (${data.studentSchoolId})`;
                
                // --- ðŸ‘‡ SORTING LOGIC STARTS HERE ðŸ‘‡ ---
                const currentItems = scannedListElement.children;
                let inserted = false;

                // Loop through existing items to find where to insert the new one
                for (let i = 0; i < currentItems.length; i++) {
                    const currentRoll = currentItems[i].getAttribute('data-roll');
                    
                    // Compare Roll Numbers (Handles numbers "1, 2, 10" correctly)
                    if (data.studentSchoolId.localeCompare(currentRoll, undefined, {numeric: true}) < 0) {
                        scannedListElement.insertBefore(listItem, currentItems[i]);
                        inserted = true;
                        break;
                    }
                }

                // If it wasn't inserted (meaning it's the largest number), add to the end
                if (!inserted) {
                    scannedListElement.appendChild(listItem);
                }
                // --- ðŸ‘† SORTING LOGIC ENDS HERE ðŸ‘† ---
                
                // 3. Add hidden input for form submission
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'presentStudents';
                hiddenInput.value = data.studentId;
                formContainer.appendChild(hiddenInput);
            }
        });
    });</script>

</body>
</html>